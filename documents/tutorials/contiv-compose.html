<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Getting Started">

    <link rel="shortcut icon" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <title>Getting Started - Contiv</title>

    <link href="/assets/stylesheets/application-2b39eabd.css" rel="stylesheet"/>

    <!--[if lt IE 9]><script src="/assets/javascripts/html5shiv-099439cc.js"></script><script src="/assets/javascripts/respond.min-1eb35b04.js"></script><![endif]-->

    
  </head>

  <body id="page-Getting Started" class=" page-Getting Started layout-documents page-sub">

<div id="header" class="navbar-static-top">
  <div class="container">
    <div class="row">
      
        <div class="navbar-header">
          <div class="navbar-brand">
              <a class="logo" href="/">Contiv</a>
            </a>
          </div>
          
        </div>
        <div class="buttons hidden-xs">
          <nav role="navigation">
            <ul class="main-links nav navbar-nav navbar-left">
              <li class="first li-under"><a href="/documents/index.html">Documentation</a></li>
              <li class="li-under"><a href="/articles/index.html">Articles</a></li>
              <li class="li-under"><a href="https://github.com/contiv" target="_blank">
                        GitHub
                        <i class="fa fa-github fa-lg"></i>
                        </a></li>
                    <li class="li-under"><a href="https://contiv-slack.herokuapp.com" target="_blank">
                        Slack
                        <i class="fa fa-slack fa-lg"></i>
                        </a></li>
                    <li><a href="https://twitter.com/projectcontiv" target="_blank">
                        Twitter
                        <i class="fa fa-twitter fa-lg"></i>
                        </a></li>
            </ul>
          </nav>
        </div>
      
    </div>
  </div>
</div>


<div class="sidebar-overlay"></div>


<aside id="sidebar" class="sidebar sidebar-default sidebar-fixed-right" role="navigation">
    
    <div class="sidebar-header header-cover">
        
        <div class="sidebar-image">
            <img src="/assets/images/logo3-a96fcb82.png" width="49px" height="56px">
        </div>
    </div>

    
    <ul class="main nav sidebar-nav">
        <li class="first"><a href="/intro/index.html">Intro</a></li>
        <li class=""><a href="/docs/index.html">Docs</a></li>
    </ul>
    <div class="divider"></div>
    
    <ul class="external nav sidebar-nav">
        <li class=""><a class="v-btn gray sml" href="https://github.com/contiv"><svg id="svg-download" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;">
  <style>
  </style>
  <path class="" d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9
    c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2
    c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2
    c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1
    c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/>
</svg>
GitHub</a></li>
    </ul>
</aside>


<div class="container">
	<div class="row">
		<div class="col-md-3 col-sm-3 col-xs-12">
					<div class="docs-sidebar hidden-print affix-top" role="complementary">
			<hr>
			<h3>User Guide</h3>
			<ul class="nav docs-sidenav">
				<li>
					<a href="/documents/gettingStarted/index.html">Getting Started</a>
					<ul class="nav">
						<li>
							<a class="hasChildren" href="/documents/gettingStarted/networking/index.html">Networking</a>
							<ul class="nav">
								<li>
									<a class="hasChildren" href="/documents/gettingStarted/networking/vagrant.html">Vagrant try out</a>
									<ul class="subnav">
										<li>
												<a href="/documents/gettingStarted/networking/swarm.html">Docker Swarm</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/k8s.html">Kubernetes</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/mesos.html">Mesos</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/nomad.html">Nomad</a>
										</li>
									</ul>
								</li>
								<li>
									<a class="hasChildren" href="/documents/gettingStarted/networking/installation.html">Netplugin Installation</a>
									<ul class="subnav">
										<li>
												<a href="/documents/gettingStarted/networking/install-swarm.html">Docker Swarm</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/install-k8s.html">Kubernetes</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/bgp.html">BGP</a>
										</li>
										<li>
												<a href="/documents/gettingStarted/networking/aci.html">Cisco ACI</a>
										</li>
									</ul>
								</li>
							</ul>
						</li>
						<li>
							<a href="/documents/gettingStarted/storage/storage.html">Storage </a>
						</li>
						<li>
							<a class="hasChildren" href="/documents/gettingStarted/cluster/index.html">Cluster </a>
							<ul class="subnav">
								<li>
										<a href="/documents/gettingStarted/cluster/vagrant.html">Vagrant Try out</a>
								</li>
								<li>
										<a href="/documents/gettingStarted/cluster/baremetal.html">Baremetal or VM installation</a>
								</li>
							</ul>
						</li>
					</ul>
				</li>
				<li>
					<a href="/documents/networking/index.html">Networking</a>
					<ul class="nav">
						<li>
								<a href="/documents/networking/concepts.html">Concepts and Terminology</a>
						</li>
						<li>
								<a href="/documents/networking/policies.html">Policies</a>
						</li>
						<li>
								<a href="/documents/networking/services.html">Service Routing</a>
						</li>
						<li>
								<a class="hasChildren" href="/documents/networking/physical-networks.html">Physical Networks</a>
								<ul class="nav">
									<li>
											<a href="/documents/networking/bgp.html">L3 Routed Networks</a>
									</li>
									<li>
											<a href="/documents/networking/l2-vlan.html">L2 Bridged Networks</a>
									</li>
									<li>
											<a href="/documents/networking/aci_ug.html">Cisco ACI</a>
									</li>
								</ul>
						</li>
						<li>
								<a href="/documents/networking/ipam.html">IPAM and Service Discovery</a>
						</li>
						<li>
								<a href="/documents/networking/ipv6.html">IPv6</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="/documents/storage/index.html">Storage</a>
					<ul class="nav">
						<li>
								<a href="/documents/storage/architecture.html">Architecture</a>
						</li>
						<li>
								<a href="/documents/storage/configuration.html">Configuration</a>
						</li>
						<li>
								<a href="/documents/storage/containers.html">Creating a container with a volume</a>
						</li>
						<li>
								<a href="/documents/storage/volcli.html">Volcli Reference</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="/documents/cluster/index.html">Cluster</a>
					<ul class="nav">
						<li>
								<a href="/documents/cluster/concepts.html">Concepts and Terminology</a>
						</li>
						<li>
								<a href="/documents/cluster/node-lifecycle.html">Node Lifecycle Management</a>
						</li>
					</ul>
				</li>
			</ul>
			<hr><p>
			<h3>Tutorials and Talks</h3>
				<ul class="nav docs-sidenav">
					<li class="active">
						<a href="/documents/tutorials/index.html">Tutorials</a>
						<ul class="nav">
							<li>
									<a href="/documents/tutorials/container-101.html">Container Networking Tutorial</a>
							</li>
							<li class="active">
									<a href="/documents/tutorials/contiv-compose.html">Policies with Networking</a>
							</li>
						</ul>
					</li>
					<li>
						<a href="/documents/demos/index.html">Demonstration Videos</a>
					</li>
					<li>
						<a href="/documents/talks/index.html">Community Talks</a>
					</li>
				</ul>
			<hr><p>
			<h3>Examples</h3>
				<ul class="nav docs-sidenav">
					<ul class="subnav">
						<li>
							<a href="/documents/samples/index.html">Docker Compose Examples</a>
						</li>
						<li>
							<a href="/documents/samples/index.html">Kubernetes Examples</a>
						</li>
						<li>
							<a href="/documents/samples/mcast.html">Multicast Examples</a>
						</li>
						<li>
							<a href="/documents/samples/nomad.html">Nomad Examples</a>
						</li>
					</ul>
				</ul>
			<hr><p>
			<h3>Reference</h3>
				<ul class="nav docs-sidenav">
					<ul class="subnav">
						<li><a href="https://godoc.org/github.com/contiv/contivmodel/client" target="_blank">Network API Reference</a><br></li>
						<li><a href="https://godoc.org/github.com/contiv/volplugin/config" target="_blank">Storage API Reference</a><br></li>
						<li><a href="https://godoc.org/github.com/contiv/cluster" target="_blank">Cluster API Reference</a><br></li>
					</ul>
				</ul>
			<hr><p>
		</div>

		</div>  
		<div id="main-content" class="col-sm-9 col-md-9 col-xs-12" role="main">
			<div class="bs-docs-section">
				
	<h1>Policies with Networking</h1>
<p>This tutorial utilizes modified libcompose to apply network policies on an application composition.</p>

<h2>How to try it out</h2>

<h3>1. Get netplugin vagrant setup:</h3>
<p>Bring up Contiv Vagrant setup as in <a href="https://github.com/contiv/netplugin/README.md">Step 1. Contiv Netplugin</a>.</p>
<pre class="highlight plaintext"><code>$ cd $HOME; mkdir -p deploy/src/github.com/contiv
$ export GOPATH=$HOME/deploy
$ cd deploy/src/github.com/contiv/
$ git clone https://github.com/contiv/netplugin
$ cd netplugin; make demo
</code></pre>

<h3>2. Get libcompose and enter VM</h3>
<pre class="highlight plaintext"><code>$ mkdir -p $GOPATH/src/github.com/docker
$ cd $GOPATH/src/github.com/docker
$ git clone https://github.com/jainvipin/libcompose
$ cd $GOPATH/src/github.com/contiv/netplugin
$ make ssh
</code></pre>

<h3>3. Inside the VM, compile libcompose</h3>
<pre class="highlight plaintext"><code>$ cd $GOPATH/src/github.com/docker/libcompose
$ git checkout deploy
$ make binary
$ ln -s $GOPATH/src/github.com/docker/libcompose/bundles/libcompose-cli /opt/gopath/bin/contiv-compose
</code></pre>

<h3>4. Build or Get container images</h3>
<p>You can either build your own images or download prebuilt sample images needed. For if you choose to use the
standard docker images, you can:</p>
<pre class="highlight plaintext"><code>$ cd $GOPATH/src/github.com/docker/libcompose/deploy/example/app
$ docker build -t web .
</code></pre>
<p>or</p>
<pre class="highlight plaintext"><code>$ docker pull jainvipin/web
$ docker tag -f web web
</code></pre>
<p>Similarly build the db image</p>
<pre class="highlight plaintext"><code>$ cd $GOPATH/src/github.com/docker/libcompose/deploy/example/db
$ docker build -t redis -f Dockerfile.redis .
</code></pre>
<p>or</p>
<pre class="highlight plaintext"><code>$ docker pull jainvipin/redis
$ docker tag -f redis redis
</code></pre>

<h3>5. Run contiv-compose and see the policies working</h3>
<p>Before we run the composition, we must create a few networks, which can be easily accomplished using:</p>
<pre class="highlight plaintext"><code>netctl net create -s 10.11.1.0/24 dev
</code></pre>
<p>Now we can fire up the example composition</p>
<pre class="highlight plaintext"><code>$ cd $GOPATH/src/github.com/docker/libcompose/deploy/example
$ contiv-compose up -d
</code></pre>
<p>You&#39;ll see something like, which is an indication that the composition is up and running</p>
<pre class="highlight plaintext"><code>WARN[0000] Note: This is an experimental alternate implementation of the Compose CLI (https://github.com/docker/compose)
INFO[0000] Creating policy contract from 'web' -&gt; 'redis'
INFO[0000] Using default policy 'TrustApp'...           
INFO[0000] User 'vagrant': applying 'TrustApp' to service 'redis'
INFO[0000]   Fetched port/protocol) = tcp/5001 from image
INFO[0000]   Fetched port/protocol) = tcp/6379 from image
INFO[0000] Project [example]: Starting project          
INFO[0000] [0/2] [web]: Starting                        
INFO[0000] [0/2] [redis]: Starting                      
INFO[0000] [1/2] [redis]: Started                       
INFO[0001] [2/2] [web]: Started        
</code></pre>
<p>What just happened was that for user <code>vagrant</code> contiv-compose picked up the default policy of <code>TrustApp</code>
This policy can be found in <code>ops.json</code> file, which is a modifiable ops policy in the same directory.
As per ops.json TrustApp policy permits all ports allowed by the application therefore in the above
run we observed that contiv-compose attempts to fetch the port information from the redis image and
applies inbound set of rules to it</p>
<p>Now, let&#39;s try to verify whether the isolation policy is working as expected</p>
<pre class="highlight plaintext"><code>$ docker exec -it example_web_1 /bin/bash
&lt; ** inside container ** &gt;
$ nc -zvw 1 example-redis 6375-6380
example_redis.dev.default [10.11.1.21] 6380 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6379 (?) open
example_redis.dev.default [10.11.1.21] 6378 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6377 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6376 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6375 (?) : Connection timed out

$ exit
&lt; ** back to linux prompt ** &gt;
</code></pre>

<h3>6. Tear down the composition</h3>
<p>Let us tear down the composition and associated policies we started earlier</p>
<pre class="highlight plaintext"><code>$ cd $GOPATH/src/github.com/docker/libcompose/deploy/example
$ contiv-compose stop
</code></pre>

<h2>Playing with a few more interesting cases</h2>

<h3>1. Trying to scale an application tier</h3>
<p>One can scale any application tier and expect that the policy be applied to the group of containers belonging to
a tier/service/group. To follow up with previous example, if we try to scale web tier as follows:</p>
<pre class="highlight plaintext"><code>$ contiv-compose up -d
$ contiv-compose scale web=5
</code></pre>
<p>With this now we can go into any of the web tier container and experiment our policy verification. For example:</p>
<pre class="highlight plaintext"><code>$ docker exec -it example_web_3 /bin/bash
&lt; ** inside container ** &gt;
$ nc -zvw 1 example-redis 6375-6380
example_redis.dev.default [10.11.1.21] 6380 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6379 (?) open
example_redis.dev.default [10.11.1.21] 6378 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6377 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6376 (?) : Connection timed out
example_redis.dev.default [10.11.1.21] 6375 (?) : Connection timed out

$ exit

$ contiv-compose stop
$ contiv-compose rm -f
</code></pre>

<h3>2. Changing the default network which</h3>
<p>Create a new <code>test</code> network first</p>
<pre class="highlight plaintext"><code>netctl net create -s 10.22.1.0/24 test
</code></pre>
<p>Then start a composition in the new network. For this we&#39;ll edit the docker-compose.yml to look like following:</p>
<pre class="highlight plaintext"><code>web:
  image: web
  ports:
   - "5000:5000"
  links:
   - redis
  net: test
redis:
  image: redis
  net: test
</code></pre>
<p>And fire up the composition using</p>
<pre class="highlight plaintext"><code>$ contiv-compose up -d
</code></pre>
<p>The new composition is started in the <code>test</code> network as specified in the composition. We can of course veify the policy, etc. between the containers now and bring the composition down using</p>
<pre class="highlight plaintext"><code>$ contiv-compose stop
</code></pre>

<h3>3. Specfying an override policy</h3>
<p>Should there be a need to specify an override policy for a service tier, we can use a policy label to do so as
in the following modified yml</p>
<pre class="highlight plaintext"><code>web:
  image: web
  ports:        
   - "5000:5000"
  links:
   - redis
  net: test
redis:
  image: redis  
  net: test       
  labels:         
   io.contiv.policy: "RedisDefault"
</code></pre>
<p>You would note that override policies for various users is specified outside the application composition, and
in operational policy file (ops.json), which states that vagrant user is allowed to use following policies:</p>
<pre class="highlight json"><code><span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="nt">"User"</span><span class="p">:</span><span class="s2">"vagrant"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"DefaultTenant"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"Networks"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test,dev"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"DefaultNetwork"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dev"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"NetworkPolicies"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"TrustApp,RedisDefault,WebDefault"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"DefaultNetworkPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TrustApp"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre>
<p>More over the override policy called <code>RedisDefault</code> is later defined as</p>
<pre class="highlight json"><code><span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="nt">"Name"</span><span class="p">:</span><span class="s2">"RedisDefault"</span><span class="p">,</span><span class="w">
                  </span><span class="nt">"Rules"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"permit tcp/6379"</span><span class="p">,</span><span class="w"> </span><span class="s2">"permit tcp/6378"</span><span class="p">,</span><span class="w"> </span><span class="s2">"permit tcp/6377"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre>
<p>So, at this point we can go ahead and fire up the composition and verify that appropriate ports are open</p>
<pre class="highlight plaintext"><code>$ contiv-compose up -d

$ docker exec -it example_web_1 /bin/bash
&lt; ** inside container ** &gt;
$ nc -zvw 1 example-redis 6375-6380
example_redis.test.default [10.22.1.26] 6380 (?) : Connection timed out
example_redis.test.default [10.22.1.26] 6379 (?) open
example_redis.test.default [10.22.1.26] 6376 (?) : Connection timed out
example_redis.test.default [10.22.1.26] 6375 (?) : Connection timed out
</code></pre>
<p>Note that in above output, ports 6377-6379 are not <code>Connection timed out</code>, which means that network is
not dropping the packet towards target example_redis service</p>
<p>Let&#39;s cleanup/stop the composition, before moving to other things</p>
<pre class="highlight plaintext"><code>$ contiv-compose stop
</code></pre>

<h3>4. Verifying that only allowed networks are permitted</h3>
<p>For a composition that attempts to speicfy a network that is not permitted for it, contiv-compose will error out.
For this we&#39;ll create a production network.</p>
<pre class="highlight plaintext"><code>$ netctl net create -s 10.33.1.0/24 production

$ cat docker-compose.yml
web:
  image: web
  ports:
   - "5000:5000"
  links:
   - redis
  net: production
redis:
  image: redis
  net: production

$ contiv-compose up -d
WARN[0000] Note: This is an experimental alternate implementation of the Compose CLI (https://github.com/docker/compose)
ERRO[0000] User 'vagrant' not allowed on network 'production'
</code></pre>

<h3>5. Verifying that only allowed policies are permitted</h3>
<p>For a composition that attempts to speicfy a disallowed policy, contiv-compose will error out.
For this we&#39;ll specify <code>AllPriviliges</code> policy for the user&#39;s vagrant, and as expected we get errored out as follows:</p>
<pre class="highlight plaintext"><code>$ cat docker-compose.yml
web:
  image: web
  ports:
   - "5000:5000"
  links:
   - redis
redis:
  image: redis
  labels:
   io.contiv.policy: "AllPriviliges"

$ contiv-compose up -d
WARN[0000] Note: This is an experimental alternate implementation of the Compose CLI (https://github.com/docker/compose)
INFO[0000] Creating policy contract from 'web' -&gt; 'redis'
ERRO[0000] User 'vagrant' not allowed to use policy 'AllPriviliges'
ERRO[0000] Error obtaining policy : Deny disallowed policy  
ERRO[0000] Failed to apply in-policy for service 'redis': Deny disallowed policy
FATA[0000] Failed to Create Network Config: Deny disallowed policy
</code></pre>

<h3>6. Specifying a override tenant (non default)</h3>
<p>We can use contiv-compose yml to specify a non default tenant to run the applications in a different tenant.
While users are typically not allowed to specify the tenancy, rather it is picked up from the user&#39;s context,
this example is kept here just for illustration:</p>
<p>For this let&#39;s create a new tenant <code>blue</code> and specify a network <code>dev</code> in <code>blue</code> tenant</p>
<pre class="highlight plaintext"><code>netctl tenant create blue
netctl net create -t blue -s 10.11.2.0/24 dev
</code></pre>
<p>Now if we create a composition that states the tenancy, we can use it as follows:</p>
<pre class="highlight plaintext"><code>$ cat docker-compose.yml
web:
  image: web
  ports:
   - "5000:5000"
  links:
   - redis
  labels:
   io.contiv.tenant: "blue"
redis:
  image: redis
  labels:
   io.contiv.tenant: "blue"

$ contiv-compose up -d

$ docker inspect example_web_1 | grep \"IPAddress\"
        "IPAddress": "",
                "IPAddress": "10.11.2.6",

$ docker inspect example_redis_1 | grep \"IPAddress\"
        "IPAddress": "",
                "IPAddress": "10.11.2.5",

</code></pre>
<p>Note that it allocated an IP from blue tenant&#39;s IP pool</p>

<h3>Some Notes and Comments</h3>

<ul>
<li>This tool is used to demonstration the automation and integration with Contiv Networking and is not meant to
be used in production.
</li>
<li>The user based authentication is expected to keep the operational policy <a name="ops_json"/><a href="#ops_json"><code>ops.json</code></a> as docker&#39;s authorization
plugin to permit only authenticated users to specify certain operations
</li>
<li>Hacking on contiv&#39;s libcompose version is welcome! Please make sure you run unit/sanity tests before
submitting a PR. It could be easily done by <a name="make_test_deploy"/><a href="#make_test_deploy"><code>make test-deploy</code></a> and &#39;make test-unit` - if both succeed
you are good
</li>
</ul>


			</div>
		</div>
	</div>
</div>